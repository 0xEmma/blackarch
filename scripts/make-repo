#!/bin/bash
# usage: make-repo [package_directory] [build_directory]
# May be run from anywhere. Must live in '$projectroot/scripts'.

# Default settings.
sign=true

# The sorts are sensitive.
export LC_ALL=POSIX

cache_keys() {
	echo >&2 'attempting to cache keys...'
	gpg -s < /dev/null > /dev/null || echo >&2 'gpg failed. continuing build anyways.'
}

cache_rights() {
	echo >&2 'attempting to cache rights...'
	sudo -v || echo >&2 'sudo failed. continuing build anyways.'
}

for arg ; do
	case "$arg" in
		--nosign|--test)
			sign=false
			;;
		*)
			echo >&2 "'$arg' not recognized."
			exit 1
			;;
	esac
done

if $sign ; then
	trap_exit() {
		# Kill gpg-agent.
		kill "$(cut -d: -f2 <<< "$GPG_AGENT_INFO")"
	}
	trap trap_exit EXIT

	# Start gpg-agent.
	[[ -z "$GPG_TTY" ]] && export GPG_TTY=$(tty)
	[[ -z "$GPG_AGENT_INFO" ]] && eval $(gpg-agent --daemon --default-cache-ttl 10000)

	cache_keys
fi

cache_rights

# Don't use the X passphrase prompt.
#unset DISPLAY

basedir=$(realpath "$(dirname "$0")")
cd "$basedir/.."

pkgdir=$(realpath packages)
repodir=$(realpath repo)
builddir=$(realpath build)
mkdir -p "$repodir"
$sign && mkdir -p "$repodir/signatures"
mkdir -p "$builddir"
mkdir -p "$builddir"

cd packages

echo >&2 'generating depth list...'
"$basedir/depth-list" |
while read item ; do (
	cache_rights

	read depth pack <<< "$item"
	echo >&2 "Depth: $depth"
	echo >&2 "Name: $pack"

	echo >&2 'copying...'

	# packages/*/<package> -> build/<package>
	cp -vfr "$pack" "$builddir"
	cd "$builddir/$pack"

	echo >&2 'cleaning...'

	# Better than nothing cleaning.
	# It is preferable to run 'git clean -dXf packages' or work with a fresh
	# clone.
	rm -vrf */
	rm -vf *.{xz,gz,zip,bzip2,gunzip2,tgz,tar}

	echo >&2 'building...'

	# Build.
	if $sign ; then
		makepkg -s --nocheck --noconfirm --sign 2>&1
	else
		makepkg -s --nocheck --noconfirm 2>&1
	fi

	# Log errors.
	ret=$?
	if [[ $ret != 0 ]] ; then
		echo >&2 "<-!-> '$pack' failed with error code $ret"
		continue
	fi

	if $sign ; then
		# Move the signatures.
		# These may interfere with package installation.
		mv *.pkg.tar.xz.sig "$repodir/signatures" ||
		  echo >&2 "<-!-> '$pack' signing failed"
	fi

	# Install if necessary.
	if [[ $depth != 1 ]] ; then
		sudo pacman --asdeps --noconfirm -U *.pkg.tar.xz ||
		  echo "<-!-> '$pack' failed to install"
	fi

	# Move package into the repo.
	mv *.pkg.tar.xz "$repodir"
) done

# Put together a database.
cd "$repodir"

if $sign ; then
	mv signatures/* .
	rmdir signatures
fi
repo-add blackarch.db.tar.gz *.pkg.tar.xz

# vim: set ft=zsh:
