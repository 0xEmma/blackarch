#!/bin/sh

file=$1

if [ $# = 0 ] ; then
    echo >&2 "usage: `basename "$0"` <file>"
    exit 1
fi

if [ ! -r "$file" ] ; then
  echo >&2 "Unable to read file '$file'." 
  exit 1
fi

url=https://www.virustotal.com/search.html
report=true

hash=`sha256sum "$file" | cut -d' ' -f1`
echo >&2 "Uploading file '$file' with hash '$hash' for analysis."

rate=`curl --silent --show-error --max-redirs 1000 -L "$url" -d "chain=$hash" |
  grep '[0-9]\+ out of [0-9]\+ antivirus' |
  sed 's/^\s*\([0-9]\+\)[^0-9]\+\([0-9]\+\).*/\1 of \2/'`
echo >&2 "$rate" # DEBUG
if [ $? != 0 ] ; then
    echo >&2 "A network error occured while attempting to upload '$file' for analysis."
    exit 1
fi

case "$rate" in
  0\ of*)
    report=false
    echo "File '$file' is clean according to VirusTotal."
    ;;
  '')
    report=false
    echo "File '$file' is unknown to VirusTotal or a network error occured."
    ;;
esac

if $report ; then
    echo "File '$file' is malware. VirusTotal detection rate: $rate."
fi

# vim: set ts=2 et:
